# @package _global_
# Ablation: dynamics ensemble size / elites.
#
# This override_expr is identical in spirit to `pets_optimizer_benchmark.yaml`, but adds
# explicit knobs to vary the dynamics model's ensemble size and the number of elites
# used by the OneDTransitionRewardModel wrapper (which controls uncertainty propagation).
defaults:
  - override /algorithm: pets
  - override /overrides: pets_cartpole
  - override /dynamics_model: gaussian_mlp_ensemble
  - override /action_optimizer: cem
  - _self_

experiment: pets_optimizer_benchmark_ensemble_size

overrides:
  # --- Ablation knobs ---
  dyn_ensemble_size: 7
  dyn_num_elites: 5

  # Wire ablation knobs into the actual model settings.
  num_elites: ${overrides.dyn_num_elites}

  # Fairness: use the same samples / iteration and iterations across optimizers.
  planning_samples_per_iter: 360
  planning_num_iters: 5

  # Base CEM settings used by all CEM-family variants.
  cem_num_workers: 4
  cem_population_size_per_worker: 90
  cem_population_size: ${overrides.planning_samples_per_iter}
  cem_num_iters: ${overrides.planning_num_iters}
  cem_elite_ratio: 0.1
  cem_alpha: 0.1
  cem_clipped_normal: false
  cem_init_jitter_scale: 0.1

  # BCEM
  cem_consensus_coef: 0.25
  cem_consensus_anneal_power: 1.0
  cem_use_value_weights: true
  cem_ir_low: 0.3
  cem_ir_high: 0.4
  cem_ir_high_target: 0.8
  cem_early_stop: true
  cem_early_stop_ir: 0.25
  cem_early_stop_mu: 1e-2
  cem_early_stop_patience: 1

  # ICEM
  cem_population_decay_factor: 1.3
  cem_colored_noise_exponent: 2.0
  cem_keep_elite_frac: 0.3

  # NES
  nes_num_iters: ${overrides.planning_num_iters}
  nes_population_size: ${overrides.planning_samples_per_iter}
  nes_sigma: 1.0
  nes_lr_mean: 0.3
  nes_lr_sigma: 0.15
  nes_min_sigma: 1e-3
  nes_max_sigma: null

  # CMA-ES
  cma_num_iters: ${overrides.planning_num_iters}
  cma_population_size: ${overrides.planning_samples_per_iter}
  cma_elite_ratio: 0.25
  cma_sigma: 1.0
  cma_alpha: 0.2
  adaptation: "diagonal"

  # MPPI
  mppi_num_iters: ${overrides.planning_num_iters}
  mppi_population_size: ${overrides.planning_samples_per_iter}
  mppi_gamma: 0.9
  mppi_sigma: 1.0
  mppi_beta: 0.9

# Apply the ensemble-size knob to the instantiated dynamics model.
dynamics_model:
  ensemble_size: ${overrides.dyn_ensemble_size}

# Trajectory optimizer agent knobs (merge into base PETS agent).
algorithm:
  silent_model_train: true
  print_planning_info: true
  agent:
    replan_freq: 1
    verbose: false
    keep_last_solution: true

    # two-stage evaluation settings
    two_stage_eval: true
    two_stage_particles_frac: 0.5
    two_stage_topk_frac: 0.2
    two_stage_max_topk: 64
    risk_spread_coef: 0.0

    # adaptive particle settings for BC-CEM (NOT used yet)
    particle_schedule: "ir"
    particles_min_frac: 0.25
    ir_particles_low: 0.3
    ir_particles_high: 0.8

    # replan skipping informed by BC-CEM's IR estimates.
    skip_replan_if_ir_low: true
    skip_replan_ir_threshold: 0.3
    skip_replan_max_frac: 0.5

